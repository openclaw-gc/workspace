# 2026-02-19

## CRITICAL INCIDENT: Model Router Cost Failure

### Discovery (6:26 AM AEDT)

**Problem identified by GC:**
- Router was logging decisions but NEVER actually switching models
- All overnight heartbeats + Gmail monitoring ran on expensive Sonnet
- Should have been running on cheap Haiku

**Damage assessment:**
- Overnight charges: ~$80 (GC reported)
- Token consumption: 8.5M tokens on Sonnet (should have been Haiku)
- Gmail monitoring: 48 checks × 178k context = 8.5M tokens
- Rate: $3 input + $15 output per 1M tokens = $76.50
- Context bloat: 178k tokens per heartbeat (absurdly large)

### Root Cause Analysis

**The router failure:**
1. ✅ Router classified messages correctly
2. ✅ Router logged decisions to `.routing-log.jsonl`
3. ❌ Router NEVER called `session_status(model=...)` to switch
4. ❌ I (Gale) was supposed to manually switch after each classification
5. ❌ For heartbeats, I never switched - stayed on expensive Sonnet

**Architectural issue:**
- Router is Node.js script, can't directly call agent tools
- `session_status()` is agent-level tool, not system command
- No OpenClaw native support for pre-message model selection hooks
- Router can only recommend, not enforce

**What I should have done:**
- Check router decision at start of every message
- Call `session_status(model=recommended)` if `shouldSwitch: true`
- Then proceed with message processing
- I didn't do this - router was effectively useless

### Immediate Response (7:50 AM)

**Actions taken:**

1. **Config patch (7:42 AM):**
   ```json
   {
     "agents": {
       "list": [{ "id": "main", "model": "anthropic/claude-haiku-4-5" }]
     }
   }
   ```
   - Changed default from Sonnet → Haiku
   - Gateway restarted automatically
   - **Effect: All future heartbeats/cron default to Haiku (12x cheaper)**

2. **Gmail monitoring disabled:**
   - Cron job `a86a633b-700a-4b69-a43b-e59eed18e506` already disabled
   - Prevents further overnight burns

3. **Documentation created:**
   - `/skills/model-router/ROUTER-FIX.md` - Root cause + fix
   - `/specs/context-compaction-strategy.md` - 4-phase optimization plan

4. **PROJECT-STATE.md updated:**
   - Added critical incident as top priority
   - Documented immediate fix + remaining work

### Cost Impact

**Before fix:**
- Default model: Sonnet ($3 input, $15 output per 1M tokens)
- Heartbeats: 48/day × 178k context = 8.5M tokens/day
- Daily cost: ~$76.50
- Monthly: ~$2,295

**After immediate fix:**
- Default model: Haiku ($0.25 input, $1.25 output per 1M tokens)
- Heartbeats: 48/day × 178k context = 8.5M tokens/day
- Daily cost: ~$6.40
- Monthly: ~$192
- **Immediate savings: 91.6%** ($70/day, $2,100/month)

**After context compaction (planned):**
- Heartbeat context: 178k → 20k (89% reduction)
- Heartbeats: 48/day × 20k = 960k tokens/day
- Daily cost: ~$0.72
- Monthly: ~$21.60
- **Total savings vs original: 99% ($75/day, $2,273/month)**

### Lessons Learned (CRITICAL)

1. **Logging ≠ Enforcement**
   - Router logging decisions without acting = useless
   - Shadow mode validation didn't catch switching failure
   - Need to test end-to-end, not just classification accuracy

2. **Default to cheap, upgrade when needed**
   - Was defaulting to Sonnet, trying to downgrade to Haiku (failed)
   - Should default to Haiku, upgrade to Sonnet/Opus when needed
   - Inverse approach is safer and cheaper

3. **Context matters as much as model**
   - 178k tokens for heartbeat is absurd (no complexity needed)
   - Even on Haiku: 8.5M tokens/day = $6.40
   - Context compaction could save another 89%

4. **Circuit breakers are mandatory**
   - No auto-pause when daily spend exceeded threshold
   - No alerts when context size ballooned
   - Need automatic cost protection, not just monitoring

5. **Test with real costs before declaring "LIVE"**
   - Router went "LIVE" on Feb 18 at 2:32 PM
   - Ran for 16 hours before cost discovered
   - Should have monitored closely for 24-48h before trusting

6. **Behavioral integration > architectural purity**
   - Wanted fully automatic router (elegant)
   - Reality: need manual switching at agent level
   - Pragmatism > perfectionism

### Remaining Work

**Phase 2: Context Compaction (TODAY)**
- Target: 178k → <25k for heartbeats
- Method: Isolated sessions, minimal context injection
- Timeline: 4 phases over 1 week
- Spec: `/specs/context-compaction-strategy.md`

**Phase 3: Budget Circuit Breakers (48H)**
- Auto-pause cron if daily spend >$10
- Alert if approaching monthly budget ($150)
- Hard limits to prevent runaway costs

**Phase 4: Router Validation (WEEKLY)**
- Continue logging all routing decisions
- Weekly analytics: verify tier accuracy
- Adjust classification keywords if needed

**Phase 5: Gmail Monitoring Re-enable**
- Only after context compaction complete
- Verify <25k context per check
- Monitor cost for 24h before trusting

### Status

**Current state (7:50 AM):**
- ✅ Bleeding stopped (config patched, Gmail disabled)
- ✅ Default to Haiku (immediate 91.6% savings)
- ✅ Root cause documented
- ✅ 4-phase optimization plan ready
- ⏳ Awaiting context compaction implementation
- ⏳ Gateway restart in progress

**GC notified:** Yes - this document captures full incident response

**Next step:** Implement Phase 2 (context compaction) per spec

---

## Summary

**What happened:** Router logged but never switched models → $80 overnight burn  
**Why:** Architectural limitation (can't auto-switch) + context bloat (178k tokens)  
**Fix applied:** Default to Haiku, disable Gmail monitoring, document everything  
**Result:** 91.6% immediate cost reduction ($76.50/day → $6.40/day)  
**Next:** Context compaction for additional 89% savings  
**Timeline:** Full fix complete within 1 week  
**Lesson:** Test with real costs, default to cheap, circuit breakers mandatory
